name: Process Pending Newsletter Subscriptions

on:
  schedule:
    # Run every 5 minutes to check for pending subscriptions
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  process-pending:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check for pending subscriptions in issues
        id: check
        run: |
          python3 << 'EOF'
          import json
          import os
          import subprocess
          
          # Get all open issues with newsletter-subscription label
          result = subprocess.run(
              ['gh', 'issue', 'list', '--label', 'newsletter-subscription', '--state', 'open', '--json', 'number,title,body'],
              capture_output=True,
              text=True,
              env={**os.environ, 'GH_TOKEN': os.getenv('GITHUB_TOKEN')}
          )
          
          if result.returncode != 0:
              print("[pending] No gh CLI or no issues found")
              print(f"[pending] {result.stderr}")
              exit(0)
          
          issues = json.loads(result.stdout)
          print(f"[pending] Found {len(issues)} pending subscription issues")
          
          if issues:
              print(f"[pending] Processing {len(issues)} subscriptions...")
              # Trigger the main subscription workflow for each
              for issue in issues:
                  print(f"[pending] Processing issue #{issue['number']}")
          EOF

      - name: Process subscriptions
        if: steps.check.outcome == 'success'
        uses: ./.github/workflows/process-subscription.yml
        with:
          trigger: 'pending-check'
