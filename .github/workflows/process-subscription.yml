name: Process Newsletter Subscription

on:
  issues:
    types: [opened]
  repository_dispatch:
    types: [newsletter-subscription]
  workflow_dispatch:

jobs:
  process-subscription:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'newsletter-subscription')) ||
      github.event_name == 'repository_dispatch' ||
      github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.WORKHUB_GH_PAT }}
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Extract subscription data
        id: extract
        run: |
          ISSUE_BODY="${{ github.event.issue.body }}"
          # Extract JSON from issue body
          JSON_DATA=$(echo "$ISSUE_BODY" | grep -A 100 '```json' | grep -B 100 '```' | grep -v '```')
          echo "json_data<<EOF" >> $GITHUB_OUTPUT
          echo "$JSON_DATA" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Add subscriber to list
        run: |
          python3 << 'EOF'
          import json
          import sys
          import os
          
          # Get subscriber data from different event types
          subscriber_data = None
          
          if os.getenv('GITHUB_EVENT_NAME') == 'repository_dispatch':
              # Get from repository_dispatch payload
              import sys
              event_path = os.getenv('GITHUB_EVENT_PATH', '/github/workflow/event.json')
              try:
                  with open(event_path, 'r') as f:
                      event_data = json.load(f)
                      subscriber_data = event_data.get('client_payload', {}).get('subscriber', {})
              except Exception as e:
                  print(f"[subscription] Error reading repository_dispatch event: {e}")
                  sys.exit(1)
          elif os.getenv('GITHUB_EVENT_NAME') == 'workflow_dispatch':
              # Get from workflow_dispatch inputs
              event_path = os.getenv('GITHUB_EVENT_PATH', '/github/workflow/event.json')
              try:
                  with open(event_path, 'r') as f:
                      event_data = json.load(f)
                      inputs = event_data.get('inputs', {})
                      subscriber_data = {
                          'name': inputs.get('name', ''),
                          'email': inputs.get('email', ''),
                          'department': inputs.get('department', ''),
                          'weeklyDigest': inputs.get('weeklyDigest', 'false') == 'true',
                          'subscribedAt': inputs.get('subscribedAt', '')
                      }
              except Exception as e:
                  print(f"[subscription] Error reading workflow_dispatch event: {e}")
                  sys.exit(1)
          else:
              # Get from issue body
              issue_body = """${{ github.event.issue.body }}"""
              
              # Find JSON block
              try:
                  json_start = issue_body.find('```json') + 7
                  json_end = issue_body.find('```', json_start)
                  json_str = issue_body[json_start:json_end].strip()
                  subscriber_data = json.loads(json_str)
              
              print(f"[subscription] Processing subscription for: {subscriber_data.get('email', 'unknown')}")
              
              # Read existing subscribers
              try:
                  with open('subscribers.json', 'r') as f:
                      subscribers = json.load(f)
              except FileNotFoundError:
                  subscribers = []
              
              # Check if email already exists
              email = subscriber_data.get('email', '').lower()
              existing = [s for s in subscribers if s.get('email', '').lower() == email]
              
              if existing:
                  print(f"[subscription] Email {email} already subscribed, updating...")
                  # Update existing subscriber
                  for i, sub in enumerate(subscribers):
                      if sub.get('email', '').lower() == email:
                          subscribers[i] = subscriber_data
                          break
              else:
                  print(f"[subscription] Adding new subscriber: {email}")
                  subscribers.append(subscriber_data)
              
              # Write back to file
              with open('subscribers.json', 'w') as f:
                  json.dump(subscribers, f, indent=2)
              
              print(f"[subscription] Total subscribers: {len(subscribers)}")
              
          except Exception as e:
              print(f"[subscription] Error processing subscription: {e}")
              sys.exit(1)
          EOF

      - name: Commit subscriber update
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add subscribers.json
          if [ "${{ github.event_name }}" == "issues" ]; then
            COMMIT_MSG="Add newsletter subscriber: ${{ github.event.issue.title }}"
          else
            COMMIT_MSG="Add newsletter subscriber via ${{ github.event_name }}"
          fi
          git diff --staged --quiet || git commit -m "$COMMIT_MSG"
          git push

      - name: Close issue
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            })
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'âœ… Subscription processed successfully! The subscriber has been added to the list.'
            })

      - name: Send confirmation email
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: |
          python3 << 'EOF'
          import json
          import smtplib
          from email.mime.text import MIMEText
          from email.mime.multipart import MIMEMultipart
          import os
          
          # Extract subscriber data based on event type
          subscriber = None
          event_name = os.getenv('GITHUB_EVENT_NAME')
          event_path = os.getenv('GITHUB_EVENT_PATH', '/github/workflow/event.json')
          
          if event_name == 'repository_dispatch':
              with open(event_path, 'r') as f:
                  event_data = json.load(f)
                  subscriber = event_data.get('client_payload', {}).get('subscriber', {})
          elif event_name == 'workflow_dispatch':
              with open(event_path, 'r') as f:
                  event_data = json.load(f)
                  inputs = event_data.get('inputs', {})
                  subscriber = {
                      'name': inputs.get('name', ''),
                      'email': inputs.get('email', ''),
                      'department': inputs.get('department', ''),
                      'weeklyDigest': inputs.get('weeklyDigest', 'false') == 'true',
                      'subscribedAt': inputs.get('subscribedAt', '')
                  }
          else:
              # From issue body
              issue_body = """${{ github.event.issue.body }}"""
              json_start = issue_body.find('```json') + 7
              json_end = issue_body.find('```', json_start)
              json_str = issue_body[json_start:json_end].strip()
              subscriber = json.loads(json_str)
          
          email = subscriber.get('email')
          name = subscriber.get('name', 'Subscriber')
          
          if not email:
              print("[email] No email address found")
              exit(0)
          
          # Email configuration
          smtp_server = os.getenv('SMTP_SERVER', 'smtp-mail.outlook.com')
          smtp_port = int(os.getenv('SMTP_PORT', '587'))
          smtp_user = os.getenv('SMTP_USER')
          smtp_password = os.getenv('SMTP_PASSWORD')
          from_email = os.getenv('FROM_EMAIL', smtp_user)
          
          if not smtp_user or not smtp_password:
              print("[email] SMTP credentials not configured, skipping email")
              exit(0)
          
          # Create email
          msg = MIMEMultipart('alternative')
          msg['Subject'] = 'Welcome to Our Newsletter!'
          msg['From'] = from_email
          msg['To'] = email
          
          text = f"""Hi {name},
          
Thank you for subscribing to our newsletter! You'll now receive updates about company events, news, and important announcements.
          
If you have any questions, please don't hesitate to reach out.
          
Best regards,
Work Hub Team"""
          
          html = f"""<html>
            <body>
              <h2>Welcome to Our Newsletter!</h2>
              <p>Hi {name},</p>
              <p>Thank you for subscribing to our newsletter! You'll now receive updates about company events, news, and important announcements.</p>
              <p>If you have any questions, please don't hesitate to reach out.</p>
              <p>Best regards,<br>Work Hub Team</p>
            </body>
          </html>"""
          
          part1 = MIMEText(text, 'plain')
          part2 = MIMEText(html, 'html')
          
          msg.attach(part1)
          msg.attach(part2)
          
          # Send email
          try:
              print(f"[email] Sending confirmation email to {email}")
              server = smtplib.SMTP(smtp_server, smtp_port)
              server.starttls()
              server.login(smtp_user, smtp_password)
              server.send_message(msg)
              server.quit()
              print(f"[email] Confirmation email sent successfully")
          except Exception as e:
              print(f"[email] Error sending email: {e}")
              exit(1)
          EOF
