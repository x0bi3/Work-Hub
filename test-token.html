<!DOCTYPE html>
<html>
<head>
    <title>Test Token</title>
</head>
<body>
    <h1>Token Test</h1>
    <button onclick="testToken()">Test Token</button>
    <pre id="result"></pre>
    
    <script>
        const GITHUB_REPO = 'x0bi3/Work-Hub';
        
        async function testToken() {
            const resultEl = document.getElementById('result');
            resultEl.textContent = 'Testing...\n';
            
            try {
                // Try localStorage first, then hardcoded fallback
                const PUBLIC_FORM_TOKEN = localStorage.getItem('github_token') || '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';
                
                if (!PUBLIC_FORM_TOKEN) {
                    resultEl.textContent = '❌ No token found!\n\n' +
                        'Please set a token:\n' +
                        '1. Open browser console (F12)\n' +
                        '2. Run: localStorage.setItem("github_token", "YOUR_TOKEN_HERE")\n' +
                        '3. Refresh this page and try again\n\n' +
                        'Or create a new token at: https://github.com/settings/tokens\n' +
                        'Required scope: repo (or public_repo for public repos)';
                    return;
                }
                
                console.log('Token source:', localStorage.getItem('github_token') ? 'localStorage' : 'hardcoded');
                console.log('Token length:', PUBLIC_FORM_TOKEN.length);
                console.log('Token preview:', PUBLIC_FORM_TOKEN.substring(0, 10) + '...');
                
                resultEl.textContent += `Token source: ${localStorage.getItem('github_token') ? 'localStorage' : 'hardcoded'}\n`;
                resultEl.textContent += `Token preview: ${PUBLIC_FORM_TOKEN.substring(0, 10)}...\n\n`;
                resultEl.textContent += 'Testing GitHub API connection...\n';
                
                // First, test authentication by checking user info
                const authResponse = await fetch('https://api.github.com/user', {
                    headers: {
                        'Accept': 'application/vnd.github.v3+json',
                        'Authorization': `Bearer ${PUBLIC_FORM_TOKEN}`
                    }
                });
                
                const authText = await authResponse.text();
                resultEl.textContent += `\nAuth Test Status: ${authResponse.status}\n`;
                
                if (!authResponse.ok) {
                    const authError = JSON.parse(authText);
                    resultEl.textContent += `Auth Error: ${authError.message}\n\n`;
                    resultEl.textContent += '❌ Token authentication failed!\n\n';
                    resultEl.textContent += 'Possible issues:\n';
                    resultEl.textContent += '1. Token is invalid or expired\n';
                    resultEl.textContent += '2. Token was revoked\n';
                    resultEl.textContent += '3. Token doesn\'t have required permissions\n';
                    resultEl.textContent += '\nTo fix:\n';
                    resultEl.textContent += '1. Create a new token at: https://github.com/settings/tokens\n';
                    resultEl.textContent += '2. Select scope: repo (or public_repo)\n';
                    resultEl.textContent += '3. Set it: localStorage.setItem("github_token", "NEW_TOKEN")\n';
                    resultEl.textContent += '4. Refresh and try again';
                    return;
                }
                
                const userData = JSON.parse(authText);
                resultEl.textContent += `✅ Authenticated as: ${userData.login}\n\n`;
                resultEl.textContent += 'Testing issue creation...\n';
                
                // Now test issue creation
                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/issues`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/vnd.github.v3+json',
                        'Authorization': `Bearer ${PUBLIC_FORM_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: 'Test Issue from Token',
                        body: 'This is a test to verify the token works.',
                        labels: ['newsletter-subscription']
                    })
                });
                
                const text = await response.text();
                resultEl.textContent += `\nIssue Creation Status: ${response.status}\n`;
                resultEl.textContent += `Response:\n${text}\n`;
                
                if (response.ok) {
                    const data = JSON.parse(text);
                    resultEl.textContent += `\n✅ Success! Issue #${data.number} created!\n`;
                    resultEl.textContent += `View it at: ${data.html_url}`;
                } else {
                    const errorData = JSON.parse(text);
                    resultEl.textContent += `\n❌ Failed to create issue!\n`;
                    resultEl.textContent += `Error: ${errorData.message}\n`;
                    
                    if (response.status === 403) {
                        resultEl.textContent += '\nToken may not have "repo" or "public_repo" scope.\n';
                        resultEl.textContent += 'Create a new token with proper permissions.';
                    } else if (response.status === 404) {
                        resultEl.textContent += '\nRepository not found or token doesn\'t have access.';
                    }
                }
            } catch (error) {
                resultEl.textContent = `Error: ${error.message}\n\n${error.stack}`;
            }
        }
    </script>
</body>
</html>
